#!/usr/bin/env php
<?php

use React\EventLoop\Factory;
use React\Http\Server as HttpServer;
use React\Socket\Server;
use Blockchain\Node;
use Blockchain\Miner;
use Blockchain\Blockchain;
use Blockchain\Block;
use Blockchain\Miner\HashDifficulty;

require __DIR__.'/../vendor/autoload.php';

$loop = Factory::create();

$node = new Node(new Miner(new Blockchain(Block::genesis()), new HashDifficulty\ZeroPrefix()));
$webServer = new HttpServer(new Node\WebServer($node));

$params = getopt('', ['port::']);
$port = $params['port'] ?? 8080;

$socket = new Server($port, $loop);
$webServer->listen($socket);

echo sprintf("Server running at http://127.0.0.1:%s\n", $port);

$loop->run();
